---
const { id, class: className } = Astro.props;
---
<section id={id} class:list={[className, "relative md:z-10 h-[150vh]"]} {...Astro.props}>

  <div class="sticky top-20 md:top-24 h-[calc(100vh-5rem)] md:h-[calc(100vh-6rem)]">

    <!-- El <section> interno ahora es un <div> para evitar ID duplicado -->
    <div class="bg-black text-white px-8 lg:px-12 py-16 md:py-20 h-full flex flex-col justify-center overflow-auto">
      <div class="mx-auto max-w-7xl w-full">
        
        <div class="mb-8 md:mb-10 w-full overflow-hidden" role="banner">
          <div class="marquee-track flex whitespace-nowrap">
            <div class="marquee-content inline-flex shrink-0 items-baseline">
              <span class="font-extrabold tracking-tight leading-[0.9]" style="font-size:clamp(3rem,10vw,9rem)">CONTACTO</span>
              <span class="text-6xl md:text-8xl lg:text-9xl leading-none mx-4 md:mx-6" aria-hidden="true">↓</span>
            </div>
            <div class="marquee-content inline-flex shrink-0 items-baseline">
              <span class="font-extrabold tracking-tight leading-[0.9]" style="font-size:clamp(3rem,10vw,9rem)">CONTACTO</span>
              <span class="text-6xl md:text-8xl lg:text-9xl leading-none mx-4 md:mx-6" aria-hidden="true">↓</span>
            </div>
            <div class="marquee-content inline-flex shrink-0 items-baseline">
              <span class="font-extrabold tracking-tight leading-[0.9]" style="font-size:clamp(3rem,10vw,9rem)">CONTACTO</span>
              <span class="text-6xl md:text-8xl lg:text-9xl leading-none mx-4 md:mx-6" aria-hidden="true">↓</span>
            </div>
            <div class="marquee-content inline-flex shrink-0 items-baseline">
              <span class="font-extrabold tracking-tight leading-[0.9]" style="font-size:clamp(3rem,10vw,9rem)">CONTACTO</span>
              <span class="text-6xl md:text-8xl lg:text-9xl leading-none mx-4 md:mx-6" aria-hidden="true">↓</span>
            </div>
          </div>
        </div>
        
        <div class="grid grid-cols-12 gap-6 md:gap-8 items-center">
          <div class="hidden md:flex md:col-span-5 items-center justify-center min-h-[500px]">
            <p class="text-2xl lg:text-3xl font-light leading-relaxed text-white/90">
              Platiquemos sobre tu proyecto y diseñemos soluciones de abastecimiento estratégico para tu empresa
            </p>
          </div>

          <div class="col-span-12 md:col-span-7 md:col-start-7">
            <form id="contact-form" class="space-y-8 max-w-xl" action="https://formspree.io/f/xnnlqrwn" method="POST" accept-charset="UTF-8">

              <div class="field group relative">
                  <label class="field-label absolute left-0 top-0 text-xl md:text-2xl text-white transition-transform duration-300 pointer-events-none">
                    Nombre *
                  </label>
                  <input
                    type="text"
                    name="nombre"
                    required
                    class="w-full bg-transparent border-b border-white hover:border-white focus:border-white outline-none transition-colors px-0 pt-8 pb-2 text-lg placeholder-transparent caret-white"
                    placeholder=""
                  />
                  <span aria-hidden="true" class="absolute right-0 bottom-2 opacity-0 group-hover:opacity-100 group-focus-within:opacity-100 translate-x-2 group-hover:translate-x-0 transition-all text-white">→</span>
              </div>
              <div class="field group relative">
                  <label class="field-label absolute left-0 top-0 text-xl md:text-2xl text-white transition-transform duration-300 pointer-events-none">
                    Empresa
                  </label>
                  <input
                    type="text"
                    name="empresa"
                    class="w-full bg-transparent border-b border-white hover:border-white focus:border-white outline-none transition-colors px-0 pt-8 pb-2 text-lg placeholder-transparent caret-white"
                    placeholder=""
                  />
                  <span aria-hidden="true" class="absolute right-0 bottom-2 opacity-0 group-hover:opacity-100 group-focus-within:opacity-100 translate-x-2 group-hover:translate-x-0 transition-all text-white">→</span>
              </div>

              <div class="field group relative">
                <label class="field-label absolute left-0 top-0 text-xl md:text-2xl text-white transition-transform duration-300 pointer-events-none">
                  Correo *
                </label>
                <input
                  type="email"
                  name="email"
                  required
                  class="w-full bg-transparent border-b border-white hover:border-white focus:border-white outline-none transition-colors px-0 pt-8 pb-2 text-lg placeholder-transparent caret-white"
                  placeholder=""
                />
                <span aria-hidden="true" class="absolute right-0 bottom-2 opacity-0 group-hover:opacity-100 group-focus-within:opacity-100 translate-x-2 group-hover:translate-x-0 transition-all text-white">→</span>
              </div>

              <div class="field group relative">
                <label class="field-label absolute left-0 top-0 text-xl md:text-2xl text-white transition-transform duration-300 pointer-events-none">
                  Mensaje *
                </label>
                <textarea
                  name="message"
                  rows="4"
                  required
                  class="w-full bg-transparent border-b border-white hover:border-white focus:border-white outline-none transition-colors px-0 pt-8 pb-2 text-lg placeholder-transparent caret-white resize-y"
                  placeholder=""
                ></textarea>
                <span aria-hidden="true" class="absolute right-0 bottom-2 opacity-0 group-hover:opacity-100 group-focus-within:opacity-100 translate-x-2 group-hover:translate-x-0 transition-all text-white">→</span>
              </div>

              <div class="pt-6">
                <button
                  type="submit"
                  class="group relative inline-flex items-center justify-between text-2xl md:text-3xl tracking-tight h-14 rounded-full px-8 border-2 border-white w-48 md:w-64 transition-all duration-300 hover:w-full hover:h-16"
                >
                  <span class="relative z-10">ENVIAR</span>
                  <span class="relative z-10 pr-4">→</span>
                </button>
              </div>
            </form>
            <div id="contact-feedback" class="mt-4 max-w-xl" aria-live="polite"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<section class="relative bg-white text-black px-8 lg:px-12 py-12">
  <div class="mx-auto max-w-7xl">
    <div class="grid grid-cols-12 gap-6 md:gap-8">
      <div class="col-span-12 md:col-span-7 md:col-start-7 max-w-xl">
        <p class="text-xs uppercase tracking-widest text-black/60 mb-2">También puedes escribirnos a</p>
        <a href="mailto:contacto@capalsa.com" class="text-xl md:text-2xl font-semibold hover:opacity-70 transition-opacity">contacto@capalsa.com</a>
      </div>
    </div>
  </div>
</section>

<style>
    .marquee-track {
    animation: marquee 10s linear infinite;
    will-change: transform;
  }

  @keyframes marquee {
    from {
      transform: translateX(0);
    }
    to {
      transform: translateX(-25%); /* Mueve 1/4 del track */
    }
  }
</style>

<script is:inline>
  (function(){
    const fields = Array.from(document.querySelectorAll('.field'));
    function moveLabel(field, toEnd){
      const label = field.querySelector('.field-label');
      if(!label) return;
      const fieldRect = field.getBoundingClientRect();
      const labelRect = label.getBoundingClientRect();
      const available = fieldRect.width - (labelRect.width);
      const target = Math.max(0, available);
      label.style.willChange = 'transform';
      label.style.transition = 'transform 300ms ease';
      label.style.transform = toEnd ? `translateX(${target}px)` : 'translateX(0)';
    }
    fields.forEach((field)=>{
      const input = field.querySelector('input, textarea');
      if(!input) return;
      input.addEventListener('focus', ()=> moveLabel(field, true));
      input.addEventListener('blur', ()=> moveLabel(field, false));
    });
    window.addEventListener('resize', ()=>{
      const active = document.activeElement;
      if(active){
        const field = active.closest('.field');
        if(field) moveLabel(field, true);
      }
    });
  })();
</script>

<script is:inline>
  (function(){
    const form = document.getElementById('contact-form');
    const feedback = document.getElementById('contact-feedback');
    if (!form) return;

    form.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      feedback.innerHTML = '';

      const submitButton = form.querySelector('button[type="submit"]');
      if (submitButton) submitButton.setAttribute('disabled', 'true');

      const data = new FormData(form);

      try {
        const res = await fetch(form.action, {
          method: form.method || 'POST',
          headers: {
            'Accept': 'application/json'
          },
          body: data
        });

        if (res.ok) {
          // show inline success message and reset form
          feedback.innerHTML = '<div class="p-4 rounded bg-green-50 border border-green-200 text-green-800">Gracias — hemos recibido tu mensaje. Te responderemos pronto.</div>';
          form.reset();
        } else {
          // try to read JSON error
          let msg = 'Ocurrió un error al enviar. Intenta de nuevo más tarde.';
          try {
            const json = await res.json();
            if (json && json.error) msg = json.error;
          } catch (e) {
            // ignore JSON parse
          }
          feedback.innerHTML = `<div class="p-4 rounded bg-red-50 border border-red-200 text-red-800">${msg}</div>`;
        }
      } catch (err) {
        feedback.innerHTML = '<div class="p-4 rounded bg-red-50 border border-red-200 text-red-800">No se pudo enviar el formulario. Revisa tu conexión e intenta de nuevo.</div>';
      } finally {
        if (submitButton) submitButton.removeAttribute('disabled');
      }
    });
  })();
</script>